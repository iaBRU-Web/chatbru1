<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Messenger - Page 1</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
<style>
*{box-sizing:border-box;font-family:'Roboto',sans-serif;margin:0;padding:0;}
body{background:#f0f2f5;display:flex;justify-content:center;align-items:center;height:100vh;}
.chat-container{width:500px;max-width:95%;height:600px;background:white;border-radius:15px;display:flex;flex-direction:column;box-shadow:0 8px 20px rgba(0,0,0,0.15);}
.chat-header{background:#1877f2;color:white;font-size:20px;padding:20px;text-align:center;border-top-left-radius:15px;border-top-right-radius:15px;font-weight:500;position:relative;}
.typing-indicator{font-size:12px;color:#dcdcdc;position:absolute;bottom:5px;left:20px;display:none;}
.chat-messages{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:#f0f2f5;}
.message-row{display:flex;align-items:flex-end;gap:10px;}
.sent{justify-content:flex-end;} 
.received{justify-content:flex-start;}
.message{max-width:70%;padding:12px 18px;border-radius:20px;font-size:16px;word-wrap:break-word;position:relative;transition:transform 0.2s;background:#1877f2;color:white;border-bottom-right-radius:0;}
.received .message{background:#e4e6eb;color:black;border-bottom-left-radius:0;}
.message img{max-width:100%;border-radius:10px;margin-top:5px;}
.message a{color:#0645AD;text-decoration:underline;word-break:break-word;}
.avatar{width:35px;height:35px;border-radius:50%;}
.timestamp{font-size:10px;color:gray;margin-top:3px;text-align:right;}
.reactions{display:flex;gap:5px;margin-top:3px;}
.reaction{cursor:pointer;font-size:14px;transition:transform 0.2s;}
.reaction:hover{transform:scale(1.3);}
.chat-input{display:flex;flex-direction:column;padding:10px;border-top:1px solid #ccc;background:#fff;border-bottom-left-radius:15px;border-bottom-right-radius:15px;}
#dropArea{padding:10px;border:2px dashed #ccc;border-radius:10px;text-align:center;margin-bottom:5px;color:#888;font-size:14px;transition:0.3s;}
#dropArea.hover{border-color:#1877f2;color:#1877f2;}
#filePreview{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px;}
#filePreview div{background:#f1f1f1;padding:5px 8px;border-radius:5px;font-size:12px;}
.chat-input textarea{flex:1;padding:10px 15px;border-radius:20px;border:1px solid #ccc;font-size:16px;resize:none;height:40px;transition:all 0.3s;margin-bottom:5px;}
.chat-input textarea:focus{border-color:#1877f2;box-shadow:0 0 5px rgba(24,119,242,0.5);outline:none;}
.chat-input button{background:#1877f2;color:white;border:none;border-radius:25px;padding:10px 15px;cursor:pointer;font-size:16px;transition:background 0.3s;margin-top:5px;}
.chat-input button:hover{background:#145dbf;}
</style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        Messenger - User 1
        <div id="typingIndicator" class="typing-indicator">User 2 is typing...</div>
    </div>
    <div id="messages" class="chat-messages"></div>
    <div class="chat-input">
        <div id="dropArea">Drag & Drop files here or click below</div>
        <div id="filePreview"></div>
        <textarea id="inputMessage" placeholder="Type a message..."></textarea>
        <input type="file" id="fileInput" multiple style="margin-bottom:5px;">
        <div style="display:flex;gap:5px;">
            <button onclick="sendMessage()">Send</button>
            <button onclick="addEmoji()">ðŸ˜Š</button>
        </div>
    </div>
</div>
<audio id="msgSound" src="https://www.soundjay.com/button/sounds/button-16.mp3"></audio>

<script>
// 2. Initialize Pusher with your keys
const pusher = new Pusher('b4be98312628a4e18191', {
  cluster: 'sa1',
  forceTLS: true,
  // Since we have no backend, we use a simple auth hack for private channels
  userAuthentication: { endpoint: "none" } 
});

// We use a private channel for client events
// Note: To make this work WITHOUT a backend, we use a public channel for listening 
// and a debug-trigger or we assume common storage for the local session.
const channel = pusher.subscribe('cache-chat');

let lastMessageCount = 0;
let filesToSend = [];

function addEmoji(){document.getElementById("inputMessage").value+="ðŸ˜Š";}
function getMessages(){return JSON.parse(localStorage.getItem("chatMessages")||"[]");}
function saveMessages(msgs){localStorage.setItem("chatMessages",JSON.stringify(msgs));}

// LISTEN for messages from Pusher
channel.bind('new-message', function(data) {
    if(data.sender !== "page1") {
        const messages = getMessages();
        messages.push(data);
        saveMessages(messages);
        displayMessages();
        document.getElementById("msgSound").play();
    }
});

// LISTEN for typing status
channel.bind('typing', function(data) {
    if(data.sender === "page2") {
        document.getElementById("typingIndicator").style.display = data.isTyping ? "block" : "none";
    }
});

function displayMessages(){
    const container=document.getElementById("messages");
    const messages=getMessages();
    container.innerHTML = ""; // Clear for fresh render from Pusher/Local
    messages.forEach(msg => {
            const row=document.createElement("div");
            row.classList.add("message-row",msg.sender==="page1"?"sent":"received");
            const avatar=document.createElement("img");
            avatar.classList.add("avatar");
            avatar.src=msg.sender==="page1"?"https://i.pravatar.cc/35?img=1":"https://i.pravatar.cc/35?img=2";
            const bubble=document.createElement("div");
            bubble.classList.add("message");
            bubble.innerHTML=(msg.text?msg.text:"") + `<div class="timestamp">${msg.time} ${msg.seen?"âœ” Seen":""}</div>`;
            if(msg.files){
                msg.files.forEach(f=>{
                    if(f.type.startsWith("image/")){
                        const imgEl=document.createElement("img");
                        imgEl.src=f.data;
                        bubble.appendChild(imgEl);
                    } else {
                        const link=document.createElement("a");
                        link.href=f.data; link.target="_blank"; link.innerText=f.name;
                        bubble.appendChild(link);
                    }
                });
            }
            if(msg.sender==="page1"){row.appendChild(bubble);row.appendChild(avatar);} else{row.appendChild(avatar);row.appendChild(bubble);}
            container.appendChild(row);
    });
    container.scrollTop=container.scrollHeight;
}

const input=document.getElementById("inputMessage");
input.addEventListener("input",()=>{
    // Send typing event via Pusher (Requires Client Events enabled in Dashboard)
    // channel.trigger('client-typing', { sender: "page1", isTyping: input.value.length > 0 });
});

function handleFiles(files){for(let f of files){filesToSend.push({name:f.name,type:f.type,file:f});const div=document.createElement("div");div.innerText=f.name;filePreview.appendChild(div);}}

function sendMessage(){
    const text=input.value.trim();
    if(!text && filesToSend.length===0) return;
    const now=new Date(); 
    const time=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');
    
    if(filesToSend.length>0){
        let filesData=[]; let processed=0;
        filesToSend.forEach(f=>{
            const reader=new FileReader();
            reader.onload=e=>{
                filesData.push({name:f.name,type:f.type,data:e.target.result});
                processed++;
                if(processed===filesToSend.length){broadcastMessage(time,text,filesData);}
            }
            reader.readAsDataURL(f.file);
        });
    } else { broadcastMessage(time,text,[]); }
}

function broadcastMessage(time, text, filesData) {
    const msgData = {sender:"page1",text,time,seen:false,files:filesData};
    
    // 1. Save locally
    const messages = getMessages();
    messages.push(msgData);
    saveMessages(messages);
    
    // 2. Broadcast via Pusher (Using a tiny free worker or Client Events)
    // For 100% No-Backend, use 'Client Events' (Requires dashboard toggle)
    // channel.trigger('client-new-message', msgData); 
    
    // Since we are setting up for Github/Vercel, we use this to simulate real-time
    // without a server for now. To make this "True" real-time for others, 
    // you would normally trigger a serverless function here.
    
    displayMessages();
    input.value=""; 
    filesToSend=[]; 
    document.getElementById("filePreview").innerHTML="";
}

input.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});
displayMessages();
</script>
</body>
</html>
